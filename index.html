<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tabungan & Pengeluaran</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:sans-serif;margin:0;padding:0;background:#f0f0f0;transition:0.3s}
.dark-mode{background:#121212;color:#eee}
#loginPage,#app{display:flex;justify-content:center;align-items:center;height:100vh}
#loginBox{background:rgba(255,255,255,0.9);padding:30px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.2)}
.dark-mode #loginBox{background:rgba(30,30,30,0.9)}
input,select,button{padding:10px;margin:5px 0;width:100%;border-radius:5px;border:1px solid #ccc;box-sizing:border-box}
button{cursor:pointer;background:#2196F3;color:#fff;border:none;transition:0.3s}
button:hover{background:#1976D2}
#app{flex-direction:column;padding:20px;align-items:flex-start}
#summary{display:flex;gap:20px;margin-bottom:20px}
.summary-box{background:#fff;padding:15px;border-radius:10px;box-shadow:0 0 5px rgba(0,0,0,0.1);min-width:150px;text-align:center;transition:0.3s}
.dark-mode .summary-box{background:#1e1e1e}
#transactionTable{width:100%;border-collapse:collapse;margin-top:10px}
#transactionTable th,#transactionTable td{border:1px solid #ccc;padding:8px;text-align:center}
.fade-in{animation:fadeIn 0.5s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
#filterMonth{max-width:200px}
</style>
</head>
<body>

<!-- Login Page -->
<div id="loginPage">
  <div id="loginBox">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="login()">Login</button>
  </div>
</div>

<!-- App Page -->
<div id="app" style="display:none;width:100%;max-width:1000px;">
  <button id="toggleMode" onclick="toggleDarkMode()">Mode Gelap</button>

  <h2>Tambah Transaksi</h2>
  <input type="date" id="date" />
  <select id="type">
    <option value="pemasukan">Pemasukan</option>
    <option value="tabungan">Tabungan</option>
    <option value="pengeluaran">Pengeluaran</option>
  </select>
  <input type="number" id="amount" placeholder="Jumlah (Rp)" />
  <input type="text" id="note" placeholder="Catatan/Keterangan (opsional)" />
  <button onclick="addTransaction()">Tambah</button>

  <h2>Ringkasan</h2>
  <div id="summary">
    <div class="summary-box" id="totalIncome">Pemasukan: Rp 0</div>
    <div class="summary-box" id="totalSaving">Tabungan: Rp 0</div>
    <div class="summary-box" id="totalExpense">Pengeluaran: Rp 0</div>
    <div class="summary-box" id="balance">Saldo Bersih: Rp 0</div>
  </div>

  <h2>Filter</h2>
  <input type="month" id="filterMonth" onchange="applyFilter()" />
  <button onclick="exportCSV()">Export CSV</button>

  <h2>Riwayat Transaksi</h2>
  <table id="transactionTable">
    <thead>
      <tr><th>Tanggal</th><th>Jenis</th><th>Jumlah</th><th>Catatan</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Chart</h2>
  <canvas id="myChart"></canvas>
</div>

<script>
window.onload = function() {
  let transactions = [];
  let filteredTransactions = [];
  let chart;
  let lastIncome = 0, lastSaving = 0, lastExpense = 0, lastBalance = 0;

  // Login
  window.login = function() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    if(username==='admin' && password==='1234'){
      document.getElementById('loginPage').style.display='none';
      document.getElementById('app').style.display='block';
      filteredTransactions = [...transactions];
      updateTable(filteredTransactions);
      updateSummary(filteredTransactions);
      updateChart(filteredTransactions);
    } else alert('Username atau password salah!');
  }

  function animateValue(id, start, end, duration = 1000) {
    const obj = document.getElementById(id);
    let startTime = null;
    const step = (timestamp) => {
      if(!startTime) startTime = timestamp;
      const progress = Math.min((timestamp - startTime)/duration, 1);
      obj.innerText = obj.id.replace(/([A-Z])/g, ' $1') + ': Rp ' + Math.floor(start + (end-start)*progress).toLocaleString();
      if(progress < 1) window.requestAnimationFrame(step);
    }
    window.requestAnimationFrame(step);
  }

  // Tambah transaksi
  window.addTransaction = function() {
    const date = document.getElementById('date').value;
    const type = document.getElementById('type').value;
    const amount = parseInt(document.getElementById('amount').value);
    const note = document.getElementById('note').value;
    if(!date || !amount || amount <= 0){ alert('Tanggal dan jumlah harus valid!'); return; }
    transactions.push({date, type, amount, note});
    applyFilter();
    document.getElementById('date').value='';
    document.getElementById('amount').value='';
    document.getElementById('note').value='';
  }

  function updateTable(list){
    const table = document.getElementById('transactionTable').getElementsByTagName('tbody')[0];
    table.innerHTML='';
    list.forEach(trx=>{
      const row = document.createElement('tr');
      row.classList.add('fade-in');
      row.innerHTML=`
        <td>${trx.date}</td>
        <td>${trx.type.charAt(0).toUpperCase() + trx.type.slice(1)}</td>
        <td>${trx.amount.toLocaleString()}</td>
        <td>${trx.note || '-'}</td>
      `;
      table.appendChild(row);
    });
  }

  function updateSummary(list){
    let income=0, saving=0, expense=0;
    list.forEach(trx=>{
      if(trx.type==='pemasukan') income+=trx.amount;
      else if(trx.type==='tabungan') saving+=trx.amount;
      else if(trx.type==='pengeluaran') expense+=trx.amount;
    });
    const balance = income - saving - expense;
    animateValue('totalIncome', lastIncome, income);
    animateValue('totalSaving', lastSaving, saving);
    animateValue('totalExpense', lastExpense, expense);
    animateValue('balance', lastBalance, balance);
    lastIncome = income; lastSaving = saving; lastExpense = expense; lastBalance = balance;
  }

  function updateChart(list){
    const labels=[], incomeData=[], savingData=[], expenseData=[], balanceData=[];
    const grouped={};
    list.forEach(trx=>{
      if(!grouped[trx.date]) grouped[trx.date]={income:0,saving:0,expense:0};
      if(trx.type==='pemasukan') grouped[trx.date].income+=trx.amount;
      else if(trx.type==='tabungan') grouped[trx.date].saving+=trx.amount;
      else grouped[trx.date].expense+=trx.amount;
    });
    let cumulativeBalance=0;
    Object.keys(grouped).sort().forEach(date=>{
      labels.push(date);
      incomeData.push(grouped[date].income);
      savingData.push(grouped[date].saving);
      expenseData.push(grouped[date].expense);
      cumulativeBalance += grouped[date].income - grouped[date].saving - grouped[date].expense;
      balanceData.push(cumulativeBalance);
    });
    if(chart) chart.destroy();
    const ctx = document.getElementById('myChart').getContext('2d');
    chart = new Chart(ctx,{
      type:'bar',
      data:{
        labels:labels,
        datasets:[
          {label:'Pemasukan', data:incomeData, backgroundColor:'blue'},
          {label:'Tabungan', data:savingData, backgroundColor:'green'},
          {label:'Pengeluaran', data:expenseData, backgroundColor:'red'},
          {label:'Saldo Bersih', data:balanceData, type:'line', borderColor:'orange', backgroundColor:'rgba(255,165,0,0.2)', fill:true, yAxisID:'y1'}
        ]
      },
      options:{
        responsive:true,
        interaction:{mode:'index', intersect:false},
        stacked:false,
        plugins:{legend:{position:'top'}},
        scales:{
          y:{type:'linear', position:'left', beginAtZero:true, title:{display:true,text:'Jumlah (Rp)'}},
          y1:{type:'linear', position:'right', beginAtZero:true, grid:{drawOnChartArea:false}, title:{display:true,text:'Saldo Bersih (Rp)'}}
        }
      }
    });
  }

  window.applyFilter = function(){
    const month = document.getElementById('filterMonth').value;
    if(month){
      filteredTransactions = transactions.filter(trx=>trx.date.startsWith(month));
    } else filteredTransactions = [...transactions];
    updateTable(filteredTransactions);
    updateSummary(filteredTransactions);
    updateChart(filteredTransactions);
  }

  window.exportCSV = function(){
    if(filteredTransactions.length===0){alert('Tidak ada transaksi untuk di-export'); return;}
    let csv='Tanggal,Jenis,Jumlah,Catatan\n';
    filteredTransactions.forEach(trx=>{ csv+=`${trx.date},${trx.type},${trx.amount},${trx.note||'-'}\n`; });
    const blob = new Blob([csv],{type:'text/csv'});
    const link=document.createElement('a');
    link.href=URL.createObjectURL(blob);
    link.download='transaksi.csv';
    link.click();
  }

  window.toggleDarkMode = function(){
    document.body.classList.toggle('dark-mode');
    document.getElementById('toggleMode').innerText=document.body.classList.contains('dark-mode')?'Mode Terang':'Mode Gelap';
  }
}
</script>

</body>
</html>
